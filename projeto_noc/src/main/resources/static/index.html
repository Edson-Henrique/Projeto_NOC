<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RESP API</title>

<!-- Bootstrap CSS -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
	crossorigin="anonymous">
	
	<link rel="stylesheet" type="text/css" href="css/style.css">

</head>
<body>

<h1>REST API com CRUD completo usando Spring Boot </h1>

	<form action="" id="formularioCadastroUsuario">

		<div class="mb-3">
			<label for="id" class="form-label">ID:</label> <input type="text"
				class="form-control" id="id" readonly="readonly"
				placeholder="ID gerado automaticamente">
		</div>
	<!-- div é um conteiner
     label descreve o campo input
     input é um campo de entrada
     o for vincula o label ao campo de entreda com mesmo nome (id) -->

		<div class="mb-3">
			<label for="nome" class="form-label">NOME:</label> <input type="text"
				class="form-control" id="nome" placeholder="Informe o nome">
		</div>

		<div class="mb-3">
			<label for="idade" class="form-label">IDADE:</label> <input
				type="number" class="form-control" id="idade"
				placeholder="Informe a idade">
		</div>


	</form>

	<button type="button" class="btn btn-primary" onclick="salvarUsuario()">Salvar</button>
	<button type="button" class="btn btn-secondary"
		onclick="document.getElementById('formularioCadastroUsuario').reset();">Novo</button> <!-- esse reset limpa os campos do formulário -->
	<button type="button" class="btn btn-success" data-bs-toggle="modal"
		data-bs-target="#modalPesquisar">Pesquisar</button>
	<button type="button" class="btn btn-danger" onclick="botaoDeletarTelaInicial()">Deletar</button>

	<!-- MODAL -->
	<div class="modal fade" id="modalPesquisar" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Buscar por
						usuário</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form>
						<div class="mb-3">
							<label for="nomeBuscar" class="col-form-label">Nome:</label> 
							<input type="text" class="form-control" id="nomeBuscar">
						</div>
						<button type="button" class="btn btn-success" onclick="buscarUsuario()">Buscar</button>
					</form>

					<div id="divTabelaDados">
					<!-- tabela bootstrap -->
					<table class="table" id="tabelaDados">
						<thead><!-- cabeçalho -->
							<tr><!-- linha -->
								<th scope="col">ID</th><!-- coluna -->
								<th scope="col">Nome</th>
								<th scope="col">Editar</th>
								<th scope="col">Deletar</th>
							</tr>
						</thead>
						<tbody><!-- corpo -->
							
						</tbody>
					</table>
				</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Fechar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"
		integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
		crossorigin="anonymous"></script>
	<!-- jQuery me permite escrever comandos em javascript com menos código -->

	<!-- Bootstrap JS -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
		crossorigin="anonymous"></script>

	<script type="text/javascript">
		function salvarUsuario() {

			var id = $("#id").val();
			var nome = $("#nome").val();
			var idade = $("#idade").val();
			
			if(nome == null || nome.trim() == '' ){
				$("#nome").focus();//foca no campo
				alert("Informe o nome!");
				return;
			}
			
			if(idade == null || idade.trim() == '' ){
				$("#idade").focus();//foca no campo
				alert("Informe a idade!");
				return;
			}
			

			/*AJAX é uma técnica que permite que uma página web se comunique com o servidor sem recarregar a página inteira,
			pois o navegador envia os dados para o servidor em segundo plano, e a resposta chega e aparece na mesma página*/

			//é uma receita de bolo:
			$.ajax({ //chamada AJAX sem jQuery
				method : "POST", //por se tratar do método salvar, que é um do tipo POST
				url : "salvar", //mapeamento do meu método
				data : JSON.stringify({
					id : id,//meus dados: 1 - parâmtros do objeto : 2 - valor do formulário
					nome : nome,
					idade : idade
				}),
				contentType : "application/json; charset=utf-8",//tipo dos dados
				success : function(response) {//se der certo, será enviada a resposta
					$("#id").val(response.id);//faz escrever meu id na tela
					alert("Dados salvos com sucesso!");
				}
			}).fail(
					function(xhr, status, errorThrow) {//xhr: traz detalhes da resposta; status: status http; errorthrow: mensagem de erro
						alert("Erro! Não conseguimos salvar os dados: "
								+ xhr.responseText);
					});

			//O objetivo final é que, ao clique do botão "salvar", este método envie um JSON para o endpoint "salvar"

		}
		
		function buscarUsuario(){
		
			var nome = $("#nomeBuscar").val();//pega o conteúdo do input Buscar
			
			if(nome != null && nome.trim() != ''){//nome.trim() é caso não seja inserido nada
				$.ajax({ //chamada AJAX sem jQuery
					method : "GET", //por se tratar do método buscarPorNome, que é um do tipo GET
					url : "buscarPeloNome", //mapeamento do meu método
					data : "nome=" + nome,// "nome" é o nome do parâmetro do endponint "buscarPeloNome" - nome é o valor da variável da função js 
					success : function(response) {//se der certo, será enviada a resposta
						$("#tabelaDados > tbody > tr").remove();//entra na tebela, depois na linha, depois na coluna e limpa os dados que já estiverem sendo exibidos lá
					
						for(var i = 0; i < response.length; i++){//como o método "buscarPorNome" retorna uma lista, devo percorre-la
							$("#tabelaDados > tbody").append("<tr id='idLinha'><td>"+response[i].id+"</td><td>"+response[i].nome+"</td><td><button type='button' class='btn btn-primary' onclick='colocarEmEdicao("+response[i].id+")'>Ver</button></td><td><button type='button' class='btn btn-danger' onclick='deletarUsuario("+response[i].id+")'>Deletar</button></td></tr>");
							//na linha acima, tenho 4 colunas: ID, Nome, botão VER, botão DELETAR
						}
					}
				}).fail(
						function(xhr, status, errorThrow) {//xhr: traz detalhes da resposta; status: status http; errorthrow: mensagem de erro
							alert("Erro ao buscar usuário pelo nome!: "
									+ xhr.responseText);
						});
			}
			
		}
		
		function colocarEmEdicao(id){
			
			
				$.ajax({ //chamada AJAX sem jQuery
					method : "GET", //por se tratar do método buscarPorNome, que é um do tipo GET
					url : "buscarPeloId", //mapeamento do meu método
					data : "id=" + id, //"id" é o nome do parâmetro do endponint "buscarPeloId" - id é o valor do parâmtro da função js
					success : function(response) {
						$("#id").val(response.id); //preeche os campos na tela  
						$("#nome").val(response.nome); //val() - se estiver vazio, pega os valores dos campos da tela; porém se estiver carregando um parâmtro com ele, acaba por inserir seu valor nos campos da tela
						$("#idade").val(response.idade);
	
						$("#modalPesquisar").modal("hide");//esconde o modal quando eu clico em "ver"
						
					}
					
				}).fail(
						function(xhr, status, errorThrow) {//xhr: traz detalhes da resposta; status: status http; errorthrow: mensagem de erro
							alert("Erro ao buscar usuário pelo id!"
									+ xhr.responseText);
						});
			}
		
		function deletarUsuario(id){

			if(confirm("Deseja mesmo deletar?")){
			
			$.ajax({ //chamada AJAX sem jQuery
				method : "DELETE", //por se tratar do método buscarPorNome, que é um do tipo GET
				url : "deletar", //mapeamento do meu método
				data : "id=" + id, //"id" é o nome do parâmetro do endponint "buscarPeloId" - id é o valor do parâmtro da função js
				success : function(response) {
					alert(response);		
					
					$('#idLinha').remove();
				}
				
			}).fail(
					function(xhr, status, errorThrow) {//xhr: traz detalhes da resposta; status: status http; errorthrow: mensagem de erro
						alert("Erro ao deletar usuário pelo id!"
								+ xhr.responseText);
					});
			
			}

		}
		
		function botaoDeletarTelaInicial(){
			var id = $("#id").val();//pega o id do campo id da tela
			
			if(id != null && id.trim() != ''){
				deletarUsuario(id);
				document.getElementById('formularioCadastroUsuario').reset();	
			}else{
				alert("Não há nenhum usuário a ser deletado!");
			}
			
		}
		
		
	</script>

</body>
</html>